# A/B Test

## Описание проекта  

Этот проект показывает проведение A/B-теста с использованием **Apache Airflow** и хранения данных в **AWS (S3) хранилище**. В проекте реализованы:  

- Генерация данных для контрольной и тестовой групп.  
- Динамическое вычисление порога значимости p-value (метод O’Brien-Fleming).  
- Оценка разницы между группами с помощью **t-теста**.  
- Автоматизация в **Apache Airflow** (DAG из трех задач).  
- Сохранение данных и результатов в S3 хранилище.  

## 1. Логика A/B-теста  

###  Расчёт размера выборки  

Размер выборки рассчитывается по стандартной формуле для A/B-тестов:  

$$
n = \frac{(Z_{\alpha/2} + Z_{\beta})^2 \cdot 2 \sigma^2}
         {\text{MDE}^2}
$$

Где:  
- $Z_{\alpha/2}$ — квантиль стандартного нормального распределения для уровня значимости $\alpha$.  
- $Z_{\beta}$ — квантиль стандартного нормального распределения для мощности теста.  
- $\sigma$ — стандартное отклонение данных.  
- **MDE** (Minimum Detectable Effect) — минимально значимый эффект, который мы хотим обнаружить.  

Используемые параметры:
- $\alpha = 0.05$  
- Мощность теста ($1 - \beta$) = 0.8  
- Стандартное отклонение ($\sigma$) = 3  
- Минимально значимый эффект ($\text{MDE}$) = 0.35 (3.5% от среднего)  

### Генерация данных  

Для моделирования данных используется **нормальное распределение** (`np.random.normal`).  

Контрольная группа моделируется с базовыми параметрами, тестовая группа получает случайное смещение $(dif)$, имитируя эффект вмешательства.  

Используемые параметры:

- Количество = 100 в "день". По 50 для каждой группы  
- Среднее ($loc$) = 10  
- Масштаб распределения ($scale$) = 3  
- Случайное изменение в тестовой группе ($dif$) = от -0.5 до 0.5
    
**[Пример данных](example/example_data.csv)**

![Распределение данных](plots/Data%20distribution.png)  

### Коррекция порога значимости (O’Brien-Fleming)  

Вместо фиксированного порога **0.05** для p-value используется **динамическое пороговое значение**, которое зависит от накопленного объёма данных. Это позволяет **досрочно завершить тест** при наличии сильного эффекта.  

Формула O’Brien-Fleming:  

$$
\alpha_t = 2 \left( 1 - \Phi \left( \frac{Z_{\alpha/2}}{\sqrt{t}} \right) \right)
$$

Где:  
- $t$ — доля накопленной информации от рассчитанного размера выборки.  
- $\Phi(x)$ — функция стандартного нормального распределения.  
- $Z_{\alpha/2}$ — квантиль нормального распределения для уровня значимости $\alpha$.  

![O'Brien-Fleming alpha spending](plots/O&apos;Brien-Fleming%20alpha%20spending.jpeg)  

## 2. Автоматизация в Apache Airflow  

A/B-тест реализован в **DAG Airflow**, который включает три задачи:  

1. **Генерация параметров теста** (пропускается, если параметры уже сгенерированы).  
2. **Генерация данных и сохранение в S3**.  
3. **Проведение теста и сохранение результатов в S3**.  

## 3. Хранение данных  

- **Формат хранения**:  
  - Данные теста — **CSV**.  
  - Параметры теста — **JSON**.  
- **Хранилище**: **Yandex Object Storage (S3)**.  
- **Доступ**: Конфигурация через `.aws/credentials`.  

## 4. Интерпретация результатов  

- Если **p-value < динамического порога**, значит, есть значимое различие между группами, и тест можно завершить.  
- Если **p-value > 0.05**, то оснований для отклонения $H_0$ нет, и тест продолжается до достижения рассчитанного размера выборки.

![История p-value](plots/P_value%20history.jpeg)  

В данном тесте значимый результат был получен на 20 день. После этого тест можно было бы завершить, приняв $H_1$.
